# Data Model: Authentication System

**Feature**: `003-login-auth-we`  
**Created**: October 21, 2025  
**Status**: Phase 1 - Design & Contracts

## Overview

This document defines the data entities, their relationships, and TypeScript interfaces for the authentication system. The data is managed by Appwrite, and we interact with it through the Appwrite SDK.

---

## Entities

### 1. User Account

Managed by Appwrite's User collection. Created via `account.create()` or OAuth.

**Appwrite Schema** (read-only from Appwrite):

```typescript
interface AppwriteUser {
  $id: string; // Unique user ID (auto-generated by Appwrite)
  $createdAt: string; // ISO 8601 timestamp
  $updatedAt: string; // ISO 8601 timestamp
  email: string; // User's email (unique, lowercase)
  name: string; // User's display name
  emailVerification: boolean; // Whether email is verified
  phone: string; // Phone number (optional, not used)
  phoneVerification: boolean; // Whether phone is verified (not used)
  prefs: Record<string, any>; // User preferences (we'll store avatar URL here)
  labels: string[]; // Labels for categorization (e.g., ['oauth:github'])
  status: boolean; // Account status (true = active)
  registration: string; // ISO 8601 registration timestamp
}
```

**Our Application User Interface**:

```typescript
interface User {
  id: string; // Maps to $id
  email: string; // User's email
  name: string; // User's display name
  emailVerified: boolean; // Maps to emailVerification
  avatar?: string; // Avatar URL (from prefs.avatar or GitHub)
  provider: "email" | "github"; // Registration provider (derived from labels)
  createdAt: Date; // Maps to $createdAt
}
```

**Relationships**:

- One User has many Sessions (1:N)
- User can have OAuth provider linked (GitHub)

**Constraints**:

- `email` must be unique (case-insensitive)
- `email` must be valid email format
- `name` is required
- `labels` contains `['oauth:github']` if registered via GitHub OAuth

---

### 2. Authentication Session

Managed by Appwrite's Session collection. Created via `account.createEmailPasswordSession()` or OAuth.

**Appwrite Schema** (read-only from Appwrite):

```typescript
interface AppwriteSession {
  $id: string; // Unique session ID (auto-generated)
  $createdAt: string; // ISO 8601 timestamp
  userId: string; // Reference to User Account ($id)
  expire: string; // ISO 8601 expiration timestamp
  provider: string; // Authentication provider ('email', 'github')
  providerUid: string; // Provider-specific user ID
  providerAccessToken: string; // OAuth access token (if applicable)
  providerAccessTokenExpiry: string; // OAuth token expiry (if applicable)
  providerRefreshToken: string; // OAuth refresh token (if applicable)
  ip: string; // IP address of session creation
  osCode: string; // Operating system code
  osName: string; // Operating system name
  osVersion: string; // Operating system version
  clientType: string; // Client type (browser, mobile, etc.)
  clientCode: string; // Client code
  clientName: string; // Client name
  clientVersion: string; // Client version
  clientEngine: string; // Browser engine
  clientEngineVersion: string; // Browser engine version
  deviceName: string; // Device name
  deviceBrand: string; // Device brand
  deviceModel: string; // Device model
  countryCode: string; // Country code (2-letter ISO)
  countryName: string; // Country name
  current: boolean; // Whether this is the current session
}
```

**Our Application Session Interface**:

```typescript
interface Session {
  id: string; // Maps to $id
  userId: string; // Reference to User
  provider: "email" | "github"; // Authentication provider
  expiresAt: Date; // Maps to expire
  current: boolean; // Whether this is the current session
  createdAt: Date; // Maps to $createdAt
}
```

**Relationships**:

- Session belongs to one User (N:1)

**Constraints**:

- `userId` references valid User `$id`
- `expire` must be in the future for active sessions
- Default expiration: 14 days (1,209,600 seconds)

---

### 3. Verification Token

Managed internally by Appwrite. We don't directly access these; Appwrite handles verification via `account.createVerification()` and `account.updateVerification()`.

**Conceptual Schema** (not directly accessible):

```typescript
interface VerificationToken {
  secret: string; // Secure token (sent in email)
  userId: string; // Reference to User Account
  expire: string; // ISO 8601 expiration timestamp (1 hour)
  type: "verification" | "recovery"; // Token type
}
```

**Constraints**:

- Tokens expire after 1 hour
- Tokens are single-use (consumed on verification)
- Users can request new tokens (rate limited: 1 per 60 seconds)

---

### 4. Password Reset Token

Similar to Verification Token, managed internally by Appwrite via `account.createRecovery()` and `account.updateRecovery()`.

**Conceptual Schema** (not directly accessible):

```typescript
interface PasswordResetToken {
  secret: string; // Secure token (sent in email)
  userId: string; // Reference to User Account
  expire: string; // ISO 8601 expiration timestamp (1 hour)
}
```

**Constraints**:

- Tokens expire after 1 hour
- Tokens are single-use (consumed on password reset)
- Generic success message shown regardless of email existence (security)

---

## Data Flow Diagrams

### Registration Flow (Email/Password)

```
┌─────────┐         ┌─────────────┐         ┌──────────┐
│ Client  │────────>│ POST /api/  │────────>│ Appwrite │
│         │ {email, │ auth/       │ account.│          │
│         │  name,  │ register    │ create()│          │
│         │  pass}  │             │         │          │
└─────────┘         └─────────────┘         └──────────┘
     │                     │                      │
     │                     │<─────────────────────┤
     │                     │   User created       │
     │                     │   (emailVerification │
     │                     │   = false)           │
     │                     │                      │
     │                     │ account.create       │
     │                     │ Verification()       │
     │                     ├─────────────────────>│
     │                     │                      │
     │                     │<─────────────────────┤
     │                     │ Verification email   │
     │                     │ sent                 │
     │<────────────────────┤                      │
     │ 201 Created         │                      │
     │ {user}              │                      │
     └─────────────────────┴──────────────────────┘
```

### Login Flow (Email/Password)

```
┌─────────┐         ┌─────────────┐         ┌──────────┐
│ Client  │────────>│ POST /api/  │────────>│ Appwrite │
│         │ {email, │ auth/login  │ account.│          │
│         │  pass}  │             │ create   │          │
│         │         │             │ EmailPass│          │
└─────────┘         └─────────────┘ Session()└──────────┘
     │                     │                      │
     │                     │<─────────────────────┤
     │                     │   Session created    │
     │                     │                      │
     │                     │ Set HTTP-only cookie │
     │<────────────────────┤ (session token)      │
     │ 200 OK              │                      │
     │ {user, session}     │                      │
     └─────────────────────┴──────────────────────┘
```

### OAuth Flow (GitHub)

```
┌─────────┐    ┌─────────────┐    ┌──────────┐    ┌─────────┐
│ Client  │───>│ GET /api/   │───>│ Appwrite │───>│ GitHub  │
│         │    │ auth/oauth/ │    │ account. │    │         │
│         │    │ github      │    │ create   │    │         │
│         │    │             │    │ OAuth2   │    │         │
└─────────┘    └─────────────┘    │ Session()│    └─────────┘
     │               │             └──────────┘         │
     │               │                  │               │
     │               │<─────────────────┤               │
     │               │ Redirect URL     │               │
     │<──────────────┤                  │               │
     │ 302 Redirect  │                  │               │
     │ to GitHub     │                  │               │
     ├───────────────┼──────────────────┼──────────────>│
     │               │                  │  Authorize    │
     │<──────────────┼──────────────────┼───────────────┤
     │               │                  │  Redirect w/  │
     │               │                  │  code         │
     ├──────────────>│ GET /api/auth/  │               │
     │               │ callback/github │               │
     │               ├─────────────────>│               │
     │               │ Exchange code    │               │
     │               │<─────────────────┤               │
     │               │ User + Session   │               │
     │<──────────────┤                  │               │
     │ 302 Redirect  │ Set HTTP-only    │               │
     │ to app        │ cookie           │               │
     └───────────────┴──────────────────┴───────────────┘
```

---

## TypeScript Type Definitions

All application-facing types will be defined in `types/auth.ts`:

```typescript
/**
 * User account information
 */
export interface User {
  id: string;
  email: string;
  name: string;
  emailVerified: boolean;
  avatar?: string;
  provider: "email" | "github";
  createdAt: Date;
}

/**
 * Authentication session
 */
export interface Session {
  id: string;
  userId: string;
  provider: "email" | "github";
  expiresAt: Date;
  current: boolean;
  createdAt: Date;
}

/**
 * Authentication response from API
 */
export interface AuthResponse {
  user: User;
  session?: Session;
}

/**
 * Login request payload
 */
export interface LoginRequest {
  email: string;
  password: string;
}

/**
 * Registration request payload
 */
export interface RegisterRequest {
  name: string;
  email: string;
  password: string;
}

/**
 * Password reset request payload
 */
export interface PasswordResetRequest {
  email: string;
}

/**
 * Password reset confirmation payload
 */
export interface PasswordResetConfirmRequest {
  userId: string;
  secret: string;
  password: string;
  passwordConfirm: string;
}

/**
 * Email verification payload
 */
export interface EmailVerificationRequest {
  userId: string;
  secret: string;
}

/**
 * Error response from API
 */
export interface ErrorResponse {
  error: string;
  message: string;
}
```

---

## Database Queries

Since Appwrite manages the database, we interact via SDK methods:

### User Queries

```typescript
// Create user account
await account.create("unique()", email, password, name);

// Get current user
await account.get();

// Update user name
await account.updateName(name);

// Update user password
await account.updatePassword(newPassword, oldPassword);

// List users (admin only, via Users service)
await users.list();

// Get user by ID (admin only)
await users.get(userId);
```

### Session Queries

```typescript
// Create email/password session
await account.createEmailPasswordSession(email, password);

// Get current session
await account.getSession("current");

// List all user sessions
await account.listSessions();

// Delete current session (logout)
await account.deleteSession("current");

// Delete all sessions
await account.deleteSessions();
```

### Verification Queries

```typescript
// Create email verification
await account.createVerification("http://localhost:3000/verify-email");

// Verify email
await account.updateVerification(userId, secret);

// Create password recovery
await account.createRecovery(email, "http://localhost:3000/reset-password");

// Confirm password recovery
await account.updateRecovery(userId, secret, password, passwordConfirm);
```

### OAuth Queries

```typescript
// Create OAuth2 session (GitHub)
await account.createOAuth2Session(
  "github",
  "http://localhost:3000/api/auth/callback/github",
  "http://localhost:3000/login?error=oauth_failed"
);
```

---

## Data Mapping Functions

Helper functions to map Appwrite models to our application interfaces:

```typescript
/**
 * Map Appwrite User to Application User
 */
export function mapAppwriteUser(appwriteUser: AppwriteUser): User {
  return {
    id: appwriteUser.$id,
    email: appwriteUser.email,
    name: appwriteUser.name,
    emailVerified: appwriteUser.emailVerification,
    avatar: appwriteUser.prefs?.avatar || undefined,
    provider: appwriteUser.labels?.includes("oauth:github")
      ? "github"
      : "email",
    createdAt: new Date(appwriteUser.$createdAt),
  };
}

/**
 * Map Appwrite Session to Application Session
 */
export function mapAppwriteSession(appwriteSession: AppwriteSession): Session {
  return {
    id: appwriteSession.$id,
    userId: appwriteSession.userId,
    provider: appwriteSession.provider as "email" | "github",
    expiresAt: new Date(appwriteSession.expire),
    current: appwriteSession.current,
    createdAt: new Date(appwriteSession.$createdAt),
  };
}
```

---

## Security Considerations

### Password Storage

- Passwords are hashed by Appwrite using Argon2
- Never log or expose passwords in API responses
- Minimum 8 characters enforced by Zod validation

### Session Management

- Sessions stored in HTTP-only cookies (not accessible via JavaScript)
- 14-day default expiration
- Sessions can be revoked individually or all at once

### Email Verification

- Verification tokens expire after 1 hour
- Rate limited: 1 verification email per 60 seconds
- Users can still log in with unverified emails (but see verification prompt)

### Password Reset

- Reset tokens expire after 1 hour
- Generic success message (don't reveal if email exists)
- Tokens are single-use

### OAuth Security

- State parameter prevents CSRF attacks (handled by Appwrite)
- Account linking requires password confirmation
- OAuth tokens stored securely by Appwrite

---

## Performance Considerations

### Caching Strategy

- User session cached in `useState` (SSR-compatible)
- Session check on middleware runs server-side only
- No client-side API calls for session validation

### Rate Limiting

- Email verification: 1 per 60 seconds
- Password reset: 5 per hour (Appwrite default)
- Login attempts: 10 per hour (Appwrite default)

### Indexing

- Email is indexed by Appwrite for fast lookups
- User ID is primary key (auto-indexed)

---

## Migration Strategy

No migrations needed - Appwrite manages the database schema. If we need to add custom user attributes in the future:

1. Use `prefs` object for user-specific data
2. Use `labels` array for categorization
3. For complex data, consider separate Appwrite collection with `userId` reference

---

## Appendix: Appwrite SDK Reference

**Installation**:

```bash
pnpm add node-appwrite
```

**Server-side initialization**:

```typescript
import { Client, Account, Users } from "node-appwrite";

const client = new Client()
  .setEndpoint(process.env.APPWRITE_ENDPOINT!)
  .setProject(process.env.APPWRITE_PROJECT_ID!)
  .setKey(process.env.APPWRITE_API_KEY!);

const account = new Account(client);
const users = new Users(client);
```

**Documentation**: https://appwrite.io/docs/references/1.5.x/server-nodejs/account
